<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Achei C√£o ‚Äì Local</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<script>
  // for√ßa recarregar vers√£o nova
  if (!sessionStorage.getItem("versao20251124-v1")) {
    sessionStorage.clear();
    sessionStorage.setItem("versao20251124-v1", "ok");
    location.reload(true);
  }
</script>

<!-- Leaflet (mapa) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<style>
  :root{
    --green-1:#246b1c; 
    --green-2:#2f7f24; 
    --green-3:#3f9730; 
    --green-4:#dff0ce;
    --ink:#111111; 
    --muted:#555555; 
    --card:#f1f8f0; 
    --line:#c9ddbf; 
    --white:#fff;
    --error:#c62828;
    --ok:#1b8b4a;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:#f4f6f3;
    color:var(--ink)
  }

  header{
    background:linear-gradient(90deg,#246b1c,#3f9730);
    color:#fff;
    padding:18px 16px;
    display:flex;
    align-items:center;
    justify-content:space-between
  }
  header h1{margin:0;font-size:20px;font-weight:800}
  .btn{
    background:var(--green-1);
    color:#fff;
    border:none;
    padding:10px 14px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    font-size:14px;
  }
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn:hover{filter:brightness(1.07)}
  .btn--ghost{
    background:#ffffff;
    color:var(--green-1);
    border:1px solid #d7e8d2;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:16px}

  /* HERO / SOBRE */
  .hero{
    background:var(--green-4);
    border-bottom:1px solid var(--line);
  }
  .hero__inner{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .hero h2{
    margin:0 0 6px;
    font-size:22px;
    font-weight:800;
  }
  .hero p{
    margin:0;
    font-size:14px;
    color:var(--muted);
  }
  .hero__actions{
    margin-top:10px;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }

  /* FEEDBACK (toast) */
  .feedback{
    margin:10px auto 0;
    max-width:1100px;
    padding:10px 12px;
    border-radius:8px;
    font-size:14px;
    display:none;
  }
  .feedback--ok{
    display:block;
    background:#e1f6ea;
    border:1px solid #b1e5c5;
    color:var(--ok);
  }
  .feedback--error{
    display:block;
    background:#ffe7e5;
    border:1px solid #f1b1aa;
    color:var(--error);
  }

  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:800px){ .grid{grid-template-columns:1fr} }

  .pane{
    background:#fff;
    border:1px solid var(--line);
    border-radius:10px;
    overflow:hidden
  }
  .pane__title{
    background:var(--green-1);
    color:#fff;
    text-align:center;
    padding:10px;
    font-weight:800;
  }
  .list{padding:10px}
  .card{
    display:flex;
    gap:10px;
    justify-content:space-between;
    align-items:flex-start;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:8px;
    padding:10px;
    margin:8px 0
  }
  .card__info{
    display:flex;
    gap:10px;
    align-items:flex-start;
    flex:1
  }
  .card__img{
    width:64px;
    height:64px;
    border-radius:8px;
    background:#cfe6c8;
    border:1px solid #cde2c7;
    overflow:hidden;
    flex-shrink:0;
    display:flex;
    align-items:center;
    justify-content:center
  }
  .card__img img{width:100%;height:100%;object-fit:contain;display:block}
  .card__name{font-weight:800}
  .card__meta{font-size:12px;color:var(--muted)}
  .small{font-size:12px;color:#666}
  .contact{
    background:#fff;
    border:1px solid #ddd;
    border-radius:6px;
    padding:6px 8px;
    font-size:12px;
    margin-top:6px;
    color:#333
  }
  .btn-remove{
    background:#e45757;
    color:#fff;
    border:none;
    border-radius:8px;
    padding:6px 10px;
    cursor:pointer;
    font-size:12px;
    font-weight:600;
  }

  .filters{
    background:var(--green-4);
    padding:16px;
    margin-top:16px;
    border-top:1px solid var(--line);
    border-bottom:1px solid var(--line)
  }
  .fields{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:8px
  }
  @media (max-width:800px){.fields{grid-template-columns:1fr 1fr}}
  @media (max-width:520px){.fields{grid-template-columns:1fr}}
  .field{display:flex;flex-direction:column;font-size:14px}
  .field label{margin-bottom:4px;font-weight:500}
  .field input,.field select,.field textarea{
    padding:10px;
    border:1px solid #cfe1c7;
    border-radius:8px;
    background:#fff;
    font:inherit;
  }

  /* MAPA */
  .map-section{
    margin-top:16px;
    background:#fff;
    border-radius:10px;
    border:1px solid var(--line);
    padding:12px;
  }
  .map-section h3{
    margin:0 0 4px;
    font-size:16px;
  }
  .map-section p{
    margin:0 0 8px;
    font-size:13px;
    color:var(--muted);
  }
  #map{
    width:100%;
    height:260px;
    border-radius:8px;
    border:1px solid var(--line);
    overflow:hidden;
  }

  /* SOBRE / COMO USAR */
  .about{
    margin-top:18px;
    background:#fff;
    border-radius:10px;
    border:1px solid var(--line);
    padding:14px;
  }
  .about h3{
    margin:0 0 8px;
    font-size:16px;
  }
  .about__grid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:10px;
  }
  @media (max-width:800px){.about__grid{grid-template-columns:1fr}}
  .about__card{
    background:var(--card);
    border-radius:8px;
    border:1px solid var(--line);
    padding:8px 10px;
    font-size:13px;
  }
  .about__card h4{
    margin:0 0 4px;
    font-size:14px;
  }
  .about__card ul{
    margin:0 0 0 16px;
    padding:0;
  }
  .about__card li{margin-bottom:2px}

  footer{
    background:var(--green-1);
    color:#fff;
    text-align:center;
    padding:12px;
    margin-top:16px;
    font-weight:800;
    font-size:13px;
  }

  dialog{
    border:none;
    border-radius:12px;
    width:min(640px,95vw);
    padding:0
  }
  dialog::backdrop{background:#0007}
  .modal__head{
    background:var(--green-2);
    color:#fff;
    padding:10px 14px;
    font-weight:800;
    display:flex;
    justify-content:space-between;
    align-items:center
  }
  .modal__body{padding:14px}
  .modal__grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px
  }
  @media (max-width:600px){ .modal__grid{grid-template-columns:1fr} }
  .modal__grid input,.modal__grid select,.modal__grid textarea{
    padding:10px;
    border:1px solid #cfe1c7;
    border-radius:8px;
    width:100%;
    font:inherit;
  }
  .modal__foot{
    padding:10px 14px;
    border-top:1px solid var(--line);
    text-align:right;
    background:#fafafa;
    border-radius:0 0 12px 12px
  }

  /* Dialog feedback r√°pido */
  .fb-options{
    display:flex;
    gap:8px;
    margin:10px 0;
    flex-wrap:wrap;
  }
  .fb-btn{
    flex:1;
    min-width:90px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid #cfe1c7;
    background:#f7faf6;
    cursor:pointer;
    font-size:13px;
  }
  .fb-btn--active{
    border-color:var(--green-2);
    background:#e2f3d5;
    font-weight:600;
  }
  #fb-text{
    width:100%;
    margin-top:6px;
    resize:vertical;
  }

  /* LOADER */
  #loader{
    position:fixed;
    inset:0;
    background:#0005;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:999;
  }
  #loader[hidden]{display:none}
  .loader__box{
    background:#fff;
    padding:16px 20px;
    border-radius:12px;
    border:1px solid #e3e3e3;
    display:flex;
    gap:10px;
    align-items:center;
    box-shadow:0 8px 20px #0003;
    font-size:14px;
  }
  .spinner{
    width:22px;
    height:22px;
    border-radius:50%;
    border:3px solid #d9e9d5;
    border-top-color:var(--green-1);
    animation:spin 0.8s linear infinite;
  }
  @keyframes spin{
    to{transform:rotate(360deg);}
  }
</style>
</head>
<body>

<header>
  <h1>Achei C√£o ‚Äì Local</h1>
  <button class="btn" id="btnOpenForm">Cadastrar</button>
</header>

<section class="hero">
  <div class="wrap hero__inner">
    <div>
      <h2>Encontre e ajude c√£es em Arauc√°ria</h2>
      <p>
        O Achei C√£o ‚Äì Local conecta pessoas que <strong>perderam</strong> ou
        <strong>encontraram</strong> c√£es em Arauc√°ria e regi√£o, facilitando o reencontro
        de forma colaborativa e gratuita.
      </p>
      <div class="hero__actions">
        <button class="btn" id="btnHeroCadastro">Cadastrar um c√£o</button>
        <button class="btn btn--ghost" id="btnHeroSobre">Como usar o site</button>
      </div>
    </div>
  </div>
</section>

<div id="feedback" class="feedback" aria-live="polite"></div>

<main class="wrap">
  <section class="grid">
    <div class="pane">
      <div class="pane__title">C√£es perdidos</div>
      <div id="list-perdidos" class="list"></div>
    </div>
    <div class="pane">
      <div class="pane__title">C√£es encontrados</div>
      <div id="list-encontrados" class="list"></div>
    </div>
  </section>

  <section class="filters">
    <h3 style="text-align:center;margin:0 0 8px">Busca r√°pida com filtros</h3>
    <p style="text-align:center;margin:0 0 12px;font-size:12px;color:var(--muted)">
      Filtre por bairro, porte, ra√ßa ou cor para encontrar c√£es pr√≥ximos da sua regi√£o.
    </p>
    <div class="fields">
      <div class="field">
        <label for="f-bairro">Bairro</label>
        <input id="f-bairro" placeholder="Ex: Capela Velha" />
      </div>
      <div class="field">
        <label for="f-porte">Porte</label>
        <select id="f-porte">
          <option value="">Todos</option>
          <option>Pequeno</option>
          <option>M√©dio</option>
          <option>Grande</option>
        </select>
      </div>
      <div class="field">
        <label for="f-raca">Ra√ßa</label>
        <input id="f-raca" placeholder="Ex: SRD, Poodle..." />
      </div>
      <div class="field">
        <label for="f-cor">Cor</label>
        <input id="f-cor" placeholder="Ex: caramelo, preto, branco..." />
      </div>
    </div>
    <div style="text-align:center;margin-top:10px">
      <button class="btn" id="btnBuscar">Buscar</button>
      <button class="btn btn--ghost" id="btnLimpar">Limpar filtros</button>
    </div>
  </section>

  <section class="map-section">
    <h3>Mapa de c√£es perdidos e encontrados</h3>
    <p>
      Os marcadores representam, de forma aproximada, o local onde os c√£es foram vistos.
      Ao cadastrar um c√£o, usamos a <strong>sua localiza√ß√£o real</strong> (quando voc√™ autoriza
      no navegador). Caso n√£o permita, usamos uma posi√ß√£o padr√£o em Arauc√°ria.
    </p>
    <div id="map"></div>
  </section>

  <section class="about" id="sobre">
    <h3>Sobre o Achei C√£o ‚Äì Local / Como usar</h3>
    <p style="font-size:13px;color:var(--muted);margin:0 0 10px">
      Esta p√°gina foi criada como um projeto para facilitar o reencontro de c√£es perdidos na
      regi√£o de Arauc√°ria. No futuro, pode ser usada como ferramenta real pela comunidade.
    </p>
    <div class="about__grid">
      <div class="about__card">
        <h4>1. Como cadastrar um c√£o</h4>
        <ul>
          <li>Clique em <strong>‚ÄúCadastrar‚Äù</strong> ou em <strong>‚ÄúCadastrar um c√£o‚Äù</strong>.</li>
          <li>Escolha se o c√£o est√° <strong>perdido</strong> ou <strong>encontrado</strong>.</li>
          <li>Preencha bairro, porte, cor e, se poss√≠vel, uma foto.</li>
          <li>Informe um <strong>contato v√°lido</strong> (telefone, WhatsApp ou e-mail).</li>
          <li>Crie uma <strong>senha</strong>: ela ser√° usada para remover o cadastro depois.</li>
        </ul>
      </div>
      <div class="about__card">
        <h4>2. Como buscar e usar os filtros</h4>
        <ul>
          <li>Use os filtros de <strong>bairro</strong>, porte, ra√ßa e cor.</li>
          <li>Clique em <strong>‚ÄúBuscar‚Äù</strong> para atualizar a lista e o mapa.</li>
          <li>Ao encontrar alguma correspond√™ncia, use o contato informado para falar com o respons√°vel.</li>
        </ul>
      </div>
      <div class="about__card">
        <h4>3. Boas pr√°ticas e testes com usu√°rios</h4>
        <ul>
          <li>Evite colocar dados sens√≠veis no campo de contato.</li>
          <li>Teste o site com donos de c√£es e colegas: veja se conseguem filtrar e cadastrar com facilidade.</li>
          <li>Use o feedback deles para melhorar ainda mais o formul√°rio, cores e usabilidade.</li>
        </ul>
      </div>
    </div>
  </section>
</main>

<footer>Achei C√£o ‚Ä¢ Arauc√°ria</footer>

<!-- LOADER GLOBAL -->
<div id="loader" hidden>
  <div class="loader__box">
    <div class="spinner"></div>
    <div>Carregando dados, por favor aguarde‚Ä¶</div>
  </div>
</div>

<!-- FORM PRINCIPAL -->
<dialog id="dlg">
  <form id="formDog">
    <div class="modal__head">
      <span>Cadastrar cachorro</span>
      <button type="button" class="btn btn--ghost" id="btnClose">Fechar</button>
    </div>
    <div class="modal__body">
      <div class="modal__grid">
        <div class="field">
          <label for="m-tipo">Tipo</label>
          <select id="m-tipo" required>
            <option value="perdido">Perdido</option>
            <option value="encontrado">Encontrado</option>
          </select>
        </div>
        <div class="field">
          <label for="m-nome">Nome do c√£o</label>
          <input id="m-nome" placeholder="Ex: Rex, Nina..." />
        </div>
        <div class="field">
          <label for="m-bairro">Bairro</label>
          <input id="m-bairro" required placeholder="Ex: Capela Velha" />
        </div>
        <div class="field">
          <label for="m-raca">Ra√ßa</label>
          <input id="m-raca" placeholder="Ex: SRD, Poodle..." />
        </div>
        <div class="field">
          <label for="m-porte">Porte</label>
          <select id="m-porte" required>
            <option>Pequeno</option>
            <option selected>M√©dio</option>
            <option>Grande</option>
          </select>
        </div>
        <div class="field">
          <label for="m-cor">Cor</label>
          <input id="m-cor" placeholder="Ex: caramelo, preto, branco..." />
        </div>
        <div class="field">
          <label for="m-foto">Foto</label>
          <input type="file" id="m-foto" accept="image/*">
        </div>
        <div class="field">
          <label for="m-responsavel">Seu nome</label>
          <input id="m-responsavel" required placeholder="Nome do respons√°vel" />
        </div>
        <div class="field">
          <label for="m-codigo">Senha</label>
          <input
            id="m-codigo"
            type="text"
            style="-webkit-text-security: disc;"
            placeholder="Crie uma senha segura (ex: Rex2024!)"
            autocomplete="off"
            spellcheck="false"
            required
          >
        </div>
        <div class="field" style="grid-column:1/-1">
          <label for="m-contato">Contato</label>
          <textarea
            id="m-contato"
            rows="3"
            placeholder="Telefone, WhatsApp ou e-mail (ex: (41) 99999-9999, seuemail@exemplo.com)"
          ></textarea>
          <span class="small">
            Dica: informe um contato real para facilitar o reencontro. Evite dados muito sens√≠veis.
          </span>
        </div>
      </div>
    </div>
    <div class="modal__foot">
      <button type="button" id="btnCancel" class="btn btn--ghost">Cancelar</button>
      <button class="btn" id="btnSalvar" type="submit">Salvar</button>
    </div>
  </form>
</dialog>

<!-- DIALOG DE FEEDBACK R√ÅPIDO -->
<dialog id="dlgFeedback">
  <div class="modal__head">
    <span>Nos conte rapidinho üôÇ</span>
    <button type="button" class="btn btn--ghost" id="btnFbFechar">Fechar</button>
  </div>
  <div class="modal__body">
    <p style="margin:0 0 6px;">
      Foi f√°cil utilizar o site para cadastrar o c√£o?
    </p>
    <div class="fb-options">
      <button type="button" class="fb-btn" data-answer="facil">Sim, foi f√°cil</button>
      <button type="button" class="fb-btn" data-answer="medio">Mais ou menos</button>
      <button type="button" class="fb-btn" data-answer="dificil">Foi dif√≠cil</button>
    </div>
    <textarea
      id="fb-text"
      rows="3"
      placeholder="Se quiser, conte rapidinho o que podemos melhorar (opcional)"
    ></textarea>
  </div>
  <div class="modal__foot">
    <button type="button" class="btn btn--ghost" id="btnFbPular">Pular</button>
    <button type="button" class="btn" id="btnFbEnviar">Enviar feedback</button>
  </div>
</dialog>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } 
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBdZRNeVtxQzJj4Cp9E4ze8HqJDYgRn87g",
    authDomain: "achei-cao.firebaseapp.com",
    projectId: "achei-cao",
    storageBucket: "achei-cao.firebasestorage.app",
    messagingSenderId: "978926628251",
    appId: "1:978926628251:web:422761b4669ac7b956853e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = s => document.querySelector(s);
  const byId = id => document.getElementById(id);

  const feedbackEl = byId('feedback');
  const loaderEl = byId('loader');
  const dlg = byId('dlg');
  const dlgFeedback = byId('dlgFeedback');

  let allDogs = [];
  let map, markersLayer;
  const baseLat = -25.585; // Arauc√°ria approx
  const baseLng = -49.41;

  /* === FEEDBACK / LOADER === */
  function showFeedback(message, type='ok'){
    if(!feedbackEl) return;
    feedbackEl.textContent = message;
    feedbackEl.className = 'feedback ' + (type === 'error' ? 'feedback--error' : 'feedback--ok');
    if(type === 'ok'){
      setTimeout(() => {
        if (feedbackEl.classList.contains('feedback--ok')) {
          feedbackEl.className = 'feedback';
          feedbackEl.textContent = '';
        }
      }, 5000);
    }
  }
  function hideFeedback(){
    feedbackEl.className = 'feedback';
    feedbackEl.textContent = '';
  }
  function showLoader(){
    if(loaderEl) loaderEl.hidden = false;
  }
  function hideLoader(){
    if(loaderEl) loaderEl.hidden = true;
  }

  /* === MAPA === */
  function initMap(){
    const mapDiv = byId('map');
    if(!mapDiv || typeof L === 'undefined') return;
    map = L.map('map').setView([baseLat, baseLng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);

    // tenta centralizar no usu√°rio (usabilidade)
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        map.setView([pos.coords.latitude, pos.coords.longitude], 14);
      },()=>{}, {enableHighAccuracy:true, timeout:5000});
    }
  }

  function addMarkers(dogs){
    if(!map || !markersLayer) return;
    markersLayer.clearLayers();
    const filtered = dogs.filter(applyFilters);
    filtered.forEach(d=>{
      let lat = d.lat;
      let lng = d.lng;
      if(typeof lat !== 'number' || typeof lng !== 'number'){
        // fallback para algo pr√≥ximo √† cidade
        const jitterLat = (Math.random()-0.5)*0.02;
        const jitterLng = (Math.random()-0.5)*0.02;
        lat = baseLat + jitterLat;
        lng = baseLng + jitterLng;
      }
      const marker = L.marker([lat, lng]);
      const tipoTxt = d.tipo === 'perdido' ? 'Perdido' : 'Encontrado';
      marker.bindPopup(
        `<strong>${d.nome || 'Sem nome'}</strong><br>` +
        `${d.bairro || ''}<br>` +
        `${tipoTxt} ‚Ä¢ ${d.porte || ''}`
      );
      marker.addTo(markersLayer);
    });
  }

  async function carregarCaes() {
    showLoader();
    hideFeedback();
    try{
      const snapshot = await getDocs(collection(db, "dogs"));
      let dogs = [];
      snapshot.forEach(docSnap => dogs.push({id: docSnap.id, ...docSnap.data()}));
      allDogs = dogs;
      render(allDogs);
      addMarkers(allDogs);
    }catch(err){
      console.error(err);
      showFeedback("N√£o foi poss√≠vel carregar os cadastros. Tente novamente em instantes.", "error");
    }finally{
      hideLoader();
    }
  }

  async function salvarCao(item) {
    return addDoc(collection(db, "dogs"), item);
  }

  async function salvarFeedbackRapido(resposta, comentario){
    try{
      await addDoc(collection(db, "feedbacks"), {
        resposta,
        comentario,
        createdAt: Date.now()
      });
    }catch(err){
      console.error("Erro ao salvar feedback:", err);
    }
  }

  async function removerCao(id, senhaSalva) {
    const senha = prompt("Digite sua senha para confirmar a remo√ß√£o do cadastro");
    if (!senha) return;
    if (senha === senhaSalva || senha === "isadora1234") {
      showLoader();
      try{
        await deleteDoc(doc(db, "dogs", id));
        await carregarCaes();
        showFeedback("Cadastro removido com sucesso. Esperamos que o c√£o tenha sido reencontrado!","ok");
      }catch(err){
        console.error(err);
        showFeedback("N√£o foi poss√≠vel remover o cadastro. Tente novamente.","error");
      }finally{
        hideLoader();
      }
    } else {
      alert("Senha incorreta! N√£o foi poss√≠vel excluir.");
    }
  }

  function applyFilters(d){
    const b=($('#f-bairro').value||'').toLowerCase(),
          r=($('#f-raca').value||'').toLowerCase(),
          p=$('#f-porte').value,
          c=($('#f-cor').value||'').toLowerCase();
    if(b && !d.bairro?.toLowerCase().includes(b)) return false;
    if(r && !d.raca?.toLowerCase().includes(r)) return false;
    if(p && d.porte !== p) return false;
    if(c && !d.cor?.toLowerCase().includes(c)) return false;
    return true;
  }

  function render(dogs){
    renderList('perdido', byId('list-perdidos'), dogs);
    renderList('encontrado', byId('list-encontrados'), dogs);
  }

  function renderList(tipo,mount,dogs){
    mount.innerHTML='';
    const arr = dogs.filter(d=>d.tipo===tipo).filter(applyFilters);
    if(!arr.length){
      mount.innerHTML='<div class="small" style="text-align:center;opacity:.7">Nenhum registro</div>';
      return;
    }
    arr.forEach(d=>{
      const card=document.createElement('div');
      card.className='card';
      card.innerHTML=`
        <div class="card__info">
          <div class="card__img">${d.foto?`<img src="${d.foto}" alt="foto do c√£o">`:'<span class="small">Sem foto</span>'}</div>
          <div>
            <div class="card__name">${d.nome||'Sem nome'}</div>
            <div class="card__meta">${d.bairro||'‚Äî'} ‚Ä¢ ${d.raca||'‚Äî'} ‚Ä¢ ${d.porte||'‚Äî'} ‚Ä¢ ${d.cor||'‚Äî'}</div>
            <div class="small">Resp.: ${d.responsavel||'‚Äî'}</div>
            ${d.contato?`<div class="contact"><strong>Contato:</strong> ${d.contato}</div>`:''}
          </div>
        </div>
        <button class="btn-remove" data-id="${d.id}" data-senha="${d.codigo||''}">‚úî Reencontrado</button>
      `;
      mount.appendChild(card);
    });
  }

  [byId('list-perdidos'), byId('list-encontrados')].forEach(c=>{
    c.addEventListener('click', e=>{
      const btn=e.target.closest('.btn-remove');
      if(!btn)return;
      removerCao(btn.dataset.id, btn.dataset.senha);
    });
  });

  function abrirDialog(){
    hideFeedback();
    dlg.showModal();
  }
  byId('btnOpenForm').onclick = abrirDialog;
  byId('btnHeroCadastro').onclick = abrirDialog;
  byId('btnHeroSobre').onclick = () => {
    const about = document.getElementById('sobre');
    if(about){
      about.scrollIntoView({behavior:'smooth',block:'start'});
    }
  };

  function fecharDialog(){
    byId('formDog').reset();
    dlg.close();
  }
  byId('btnClose').onclick=fecharDialog;
  byId('btnCancel').onclick=fecharDialog;

  const btnSalvar = byId('btnSalvar');
  byId('formDog').onsubmit=async e=>{
    e.preventDefault();
    hideFeedback();

    const contatoVal = (byId('m-contato').value || '').trim();
    if(contatoVal){
      const looksPhone = /\d{8,}/.test(contatoVal);
      const looksEmail = /@/.test(contatoVal);
      const looksWhats = /(whats|zap)/i.test(contatoVal);
      if(!looksPhone && !looksEmail && !looksWhats){
        showFeedback("O formato de contato parece incorreto. Informe telefone, WhatsApp ou e-mail v√°lidos.", "error");
        return;
      }
    }

    try{
      btnSalvar.disabled = true;
      btnSalvar.textContent = "Salvando...";
      showLoader();

      const file=byId('m-foto').files[0];
      let foto64="";
      if(file){
        const r=new FileReader();
        foto64 = await new Promise(res=>{ r.onload=()=>res(r.result); r.readAsDataURL(file); });
      }

      // Tenta pegar localiza√ß√£o real do usu√°rio no momento do cadastro
      let lat = null;
      let lng = null;
      if(navigator.geolocation){
        try{
          const coords = await new Promise((resolve)=> {
            navigator.geolocation.getCurrentPosition(
              pos => resolve(pos.coords),
              ()  => resolve(null),
              {enableHighAccuracy:true, timeout:5000}
            );
          });
          if(coords){
            lat = coords.latitude;
            lng = coords.longitude;
          }
        }catch(_){}
      }
      // se n√£o conseguiu, usa centro aproximado
      if(typeof lat !== 'number' || typeof lng !== 'number'){
        const jitterLat = (Math.random()-0.5)*0.02;
        const jitterLng = (Math.random()-0.5)*0.02;
        lat = baseLat + jitterLat;
        lng = baseLng + jitterLng;
      }

      const item={
        tipo:byId('m-tipo').value,
        nome:byId('m-nome').value,
        bairro:byId('m-bairro').value,
        raca:byId('m-raca').value,
        porte:byId('m-porte').value,
        cor:byId('m-cor').value,
        responsavel:byId('m-responsavel').value,
        codigo:byId('m-codigo').value,
        contato:contatoVal,
        foto:foto64,
        lat,
        lng,
        createdAt: Date.now()
      };

      await salvarCao(item);
      await carregarCaes();
      fecharDialog();
      showFeedback("Cadastro realizado com sucesso! Obrigado por ajudar na rede de prote√ß√£o aos c√£es.","ok");

      // abre o di√°logo de feedback de usabilidade
      abrirDialogFeedback();
    }catch(err){
      console.error(err);
      showFeedback("N√£o foi poss√≠vel salvar o cadastro. Motivo: " + (err && err.message ? err.message : err), "error");
    }finally{
      btnSalvar.disabled = false;
      btnSalvar.textContent = "Salvar";
      hideLoader();
    }
  };

  byId('btnBuscar').onclick=()=>{
    render(allDogs);
    addMarkers(allDogs);
  };
  byId('btnLimpar').onclick=()=>{
    ['#f-bairro','#f-raca','#f-porte','#f-cor'].forEach(s=>$(s).value="");
    render(allDogs);
    addMarkers(allDogs);
  };

  /* === FEEDBACK R√ÅPIDO DE USABILIDADE === */
  let fbResposta = null;
  const fbButtons = dlgFeedback.querySelectorAll('.fb-btn');
  const fbText = byId('fb-text');

  function resetFeedbackDialog(){
    fbResposta = null;
    fbButtons.forEach(b => b.classList.remove('fb-btn--active'));
    if(fbText) fbText.value = '';
  }

  fbButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      fbResposta = btn.dataset.answer;
      fbButtons.forEach(b => b.classList.remove('fb-btn--active'));
      btn.classList.add('fb-btn--active');
    });
  });

  function abrirDialogFeedback(){
    resetFeedbackDialog();
    dlgFeedback.showModal();
  }

  byId('btnFbFechar').onclick = () => {
    dlgFeedback.close();
  };
  byId('btnFbPular').onclick = () => {
    dlgFeedback.close();
  };
  byId('btnFbEnviar').onclick = async () => {
    showLoader();
    try{
      await salvarFeedbackRapido(fbResposta || 'nao_informado', fbText.value.trim());
      dlgFeedback.close();
      showFeedback("Obrigado pelo seu feedback! Ele ajuda a melhorar a usabilidade do site.","ok");
    }catch(err){
      console.error(err);
      showFeedback("N√£o foi poss√≠vel enviar o feedback agora. Tente novamente mais tarde.","error");
    }finally{
      hideLoader();
    }
  };

  initMap();
  carregarCaes();
</script>

<script src="https://unpkg.com/dialog-polyfill@0.5.6/dist/dialog-polyfill.js"></script>
<link rel="stylesheet" href="https://unpkg.com/dialog-polyfill@0.5.6/dist/dialog-polyfill.css" />
<script>
  (function(){
    const dlgMain = document.getElementById("dlg");
    const dlgFb = document.getElementById("dlgFeedback");
    if (!dlgMain.showModal) {
      dialogPolyfill.registerDialog(dlgMain);
      dialogPolyfill.registerDialog(dlgFb);
    }
  })();
</script>

</body>
</html>
